{% extends 'airbnbclone/base.html' %}

{% block body %}
{% include 'airbnbclone/filter_navbar.html' %}

<div class="container">
    <h5>All the Homes</h5>

    <div class="row">
        <div class="homes col-8">
            <div class="row">
                {% if listings %}
                {% for listing in listings %}
                <div class="home col-4">
                    <a href="{% url 'airbnbclone:listing' listing_id=listing.id %}">{{ listing.name }}</a>
                    <p>{{listing.listing_type}}, {{listing.bed}} beds</p>
                    <p>from {{listing.price}} per night - Free cancellation</p>
                    <p>{{listing.average_rating}}/5 stars<span class="bluecolor fineprint">
                            {% if listing.average_rating < 0.5 %}
                            <i class="fa fa-star-o"></i> <i class="fa fa-star-o"></i> <i class="fa fa-star-o"></i> <i class="fa fa-star-o"></i> <i class="fa fa-star-o"></i>
                            {% elif listing.average_rating < 1 %}
                            <i class="fa fa-star-half-o"></i> <i class="fa fa-star-o"></i> <i class="fa fa-star-o"></i> <i class="fa fa-star-o"></i> <i class="fa fa-star-o"></i>
                            {% elif listing.average_rating < 1.5 %}
                            <i class="fa fa-star"></i> <i class="fa fa-star-o"></i> <i class="fa fa-star-o"></i> <i class="fa fa-star-o"></i> <i class="fa fa-star-o"></i>
                            {% elif listing.average_rating < 2 %}
                            <i class="fa fa-star"></i> <i class="fa fa-star-half-o"></i> <i class="fa fa-star-o"></i> <i class="fa fa-star-o"></i> <i class="fa fa-star-o"></i>
                            {% elif listing.average_rating < 2.5 %}
                            <i class="fa fa-star"></i> <i class="fa fa-star"></i> <i class="fa fa-star-o"></i> <i class="fa fa-star-o"></i> <i class="fa fa-star-o"></i>
                            {% elif listing.average_rating < 3 %}
                            <i class="fa fa-star"></i> <i class="fa fa-star"></i> <i class="fa fa-star-half-o"></i> <i class="fa fa-star-o"></i> <i class="fa fa-star-o"></i>
                            {% elif listing.average_rating < 3.5 %}
                            <i class="fa fa-star"></i> <i class="fa fa-star"></i> <i class="fa fa-star"></i> <i class="fa fa-star-o"></i> <i class="fa fa-star-o"></i>
                            {% elif listing.average_rating < 4 %}
                            <i class="fa fa-star"></i> <i class="fa fa-star"></i> <i class="fa fa-star"></i> <i class="fa fa-star-half-o"></i> <i class="fa fa-star-o"></i>
                            {% elif listing.average_rating < 4.5 %}
                            <i class="fa fa-star"></i> <i class="fa fa-star"></i> <i class="fa fa-star"></i> <i class="fa fa-star"></i> <i class="fa fa-star-o"></i>
                            {% elif listing.average_rating < 5 %}
                            <i class="fa fa-star"></i> <i class="fa fa-star"></i> <i class="fa fa-star"></i> <i class="fa fa-star"></i> <i class="fa fa-star-half-o"></i>
                            {% elif listing.average_rating == 5 %}
                            <i class="fa fa-star"></i> <i class="fa fa-star"></i> <i class="fa fa-star"></i> <i class="fa fa-star"></i> <i class="fa fa-star"></i>
                            {% endif %}</span></p>

                </div>
                {% endfor %}
                {% endif %}
            </div>
        </div>
    
        <div class="col-3">
            <div id="map-search">

            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}

<script>


let map;
var infoWindow;
var service;
var mapCenter = {lat: -33.867, lng: 151.206};
var all_places;

function initMap() {
    var input = document.getElementById('search_input');
    var autocomplete = new google.maps.places.Autocomplete(input);
    
    map = new google.maps.Map(document.getElementById('map-search'), {
    center: mapCenter,
    zoom: 10,
    styles: [{
      stylers: [{ visibility: 'simplified' }]
    }, {
      elementType: 'labels',
      stylers: [{ visibility: 'off' }]
    }]
  });

  infoWindow = new google.maps.InfoWindow();
  console.log("ready for service")
  
  service = new google.maps.places.PlacesService(map);

  // The idle event is a debounced event, so we can query & listen without
  // throwing too many requests at the server.
//   map.addListener('idle', performSearch);
}

function performSearch() {
  var request = {
    bounds: map.getBounds(),
    keyword: 'best view'
  };
  service.radarSearch(request, callback);

  console.log("in perform Search");
}

function callback(locations) {
    for (var i = 0, result; result = locations[i]; i++) {
        addMarker(result);
    }   
}

function addMarker(place) {
    let addr_lat = place['fields']['addr_lat']
    let addr_lon = place['fields']['addr_lon']
    var myLatLng = {lat: addr_lat, lng: addr_lon};
  
  console.log(myLatLng)
  var marker = new google.maps.Marker({
    map: map,
    position: myLatLng,
  });

  console.log("finish marker begin listener");

  google.maps.event.addListener(marker, 'click', function() {

    let redirectlink = "/listing/" + place['pk']
    
  var contentString = 
      '<div><a href=' + redirectlink + '>'+ place['fields']['address'] +'</a></div>';

    let request = {placeId: place['pk']}

    service.getDetails(request, function(result, status) {
      infoWindow.setContent(contentString);
      infoWindow.open(map, marker);
    });
  });
}


$(document).ready(function() {
    console.log("ready");

    $("#searchInput").keypress(function(event) {
        if (event.keyCode == 13) {
        
            event.preventDefault();
            console.log($(this).val())

            $.ajax({
                beforeSend: setCsrfToken,
                type: "POST",
                url: "/search_by_map",
                data: {
                    "html_loc": $("input[name=html_loc").val(),
                },
                success: function (response) {
                    console.log(response);
                    mapCenter = {lat: response['center_lat'], lng: response['center_lon']}
                    initMap();
                    callback(response['results']);
                    map.addListener('idle', performSearch);
                },

                error: function(response) {
                    console.log("No Such Location");
                }
            });
        }
    });
});

</script>

<script src="https://maps.googleapis.com/maps/api/js?key={{api_key}}&callback=initMap&libraries=places" async defer>
</script>

{% endblock %}